# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-builder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: OpenWrt Builder (RAX3000M)

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      enable_5g_25db:
        description: 'å¯ç”¨ 5G 25dB ä¿®æ”¹'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
  REPO_BRANCH: openwrt-24.10-6.6
  DEVICE_NAME: rax3000m
  ENABLE_5G_25DB: ${{ github.event.inputs.enable_5g_25db || 'true' }}
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ (Initialization environment)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: å…‹éš†æºç  (Clone source code)
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: åŠ è½½è‡ªå®šä¹‰ Feeds (Load custom feeds)
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: æ›´æ–° Feeds (Update feeds)
        run: cd openwrt && ./scripts/feeds update -a

      - name: å®‰è£… Feeds (Install feeds)
        run: cd openwrt && ./scripts/feeds install -a

      # ğŸ”¥ğŸ”¥ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ç›´æ¥ä¿®æ”¹é©±åŠ¨æºç ï¼Œå¡«è¡¥ç¼ºå¤±çš„å®šä¹‰ ğŸ”¥ğŸ”¥ğŸ”¥
      - name: ä¿®å¤ MTK é©±åŠ¨æºç  bug (Fix Source Code)
        run: |
          cd openwrt
          
          # å¯»æ‰¾ mtk_eth_soc.c æ–‡ä»¶ (é€šå¸¸åœ¨ target/linux/mediatek/files-6.6... ä¸‹)
          DRIVER_FILE=$(find target/linux/mediatek -name "mtk_eth_soc.c" -type f | head -n 1)
          
          if [ -f "$DRIVER_FILE" ]; then
            echo "âœ… æ‰¾åˆ°é©±åŠ¨æ–‡ä»¶: $DRIVER_FILE"
            echo "æ­£åœ¨æ³¨å…¥ç¼ºå¤±çš„å®å®šä¹‰..."
            
            # åœ¨ include éƒ¨åˆ†ä¹‹åæ’å…¥ç¼ºå¤±çš„å®šä¹‰
            # è¿™é‡Œçš„å®šä¹‰æ˜¯ dummy å€¼ï¼Œç›®çš„æ˜¯è®©ç¼–è¯‘å™¨èƒ½è·‘é€šï¼Œé˜²æ­¢ undeclared é”™è¯¯
            sed -i '/#include <linux\/platform_device.h>/a \
            /* Fixed by GitHub Actions: Define missing symbols to prevent build failure */ \
            #ifndef HIT_BIND_FORCE_TO_CPU \
            #define HIT_BIND_FORCE_TO_CPU 1 \
            #endif \
            #ifndef MTK_FE_START_RESET \
            #define MTK_FE_START_RESET 1 \
            #endif \
            #ifndef MTK_FE_RESET_NAT_DONE \
            #define MTK_FE_RESET_NAT_DONE 2 \
            #endif \
            #ifndef MTK_FE_RESET_DONE \
            #define MTK_FE_RESET_DONE 3 \
            #endif \
            #ifndef MTK_WIFI_RESET_DONE \
            #define MTK_WIFI_RESET_DONE 4 \
            #endif \
            #ifndef MTK_WIFI_CHIP_ONLINE \
            #define MTK_WIFI_CHIP_ONLINE 5 \
            #endif \
            #ifndef MTK_WIFI_CHIP_OFFLINE \
            #define MTK_WIFI_CHIP_OFFLINE 6 \
            #endif' "$DRIVER_FILE"
            
            echo "âœ… æºç ä¿®è¡¥å®Œæˆï¼"
          else
            echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° mtk_eth_soc.cï¼Œå¯èƒ½è·¯å¾„å·²å˜æ›´ï¼Œè·³è¿‡æºç ä¿®è¡¥ã€‚"
          fi

      - name: åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶
        run: |
          cd openwrt
          # 1. åŸºç¡€é…ç½®
          cat << EOF > .config
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_cmcc_rax3000m=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
          # æ ¸å¿ƒç½‘ç»œç»„ä»¶ (å°è¯•å¼€å¯ä¾èµ–)
          CONFIG_PACKAGE_kmod-nf-flow=y
          CONFIG_PACKAGE_kmod-mediatek_wed=y
          # æ’ä»¶
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-sqm=y
          CONFIG_PACKAGE_luci-app-turboacc=y
          CONFIG_PACKAGE_luci-app-turboacc_INCLUDE_OFFLOADING=y
          CONFIG_PACKAGE_luci-app-statistics=y
          CONFIG_PACKAGE_luci-app-vnstat2=y
          CONFIG_PACKAGE_luci-app-diskman=y
          CONFIG_PACKAGE_luci-app-samba4=y
          CONFIG_PACKAGE_autosamba=y
          CONFIG_PACKAGE_luci-app-nlbwmon=y
          CONFIG_PACKAGE_luci-app-frpc=y
          CONFIG_PACKAGE_luci-app-wol=y
          CONFIG_PACKAGE_luci-app-ttyd=y
          CONFIG_PACKAGE_luci-app-upnp=y
          EOF
          
          make defconfig

      - name: ä¿®æ”¹ 5G 25dB
        if: env.ENABLE_5G_25DB == 'true'
        run: |
          cd openwrt
          EEPROM_FILE=package/mtk/drivers/mt_wifi/files/mt7981-default-eeprom/MT7981_iPAiLNA_EEPROM.bin
          
          if [ ! -f "$EEPROM_FILE" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ° EEPROM æ–‡ä»¶ï¼š$EEPROM_FILE"
            echo "è·³è¿‡ 5G 25dB ä¿®æ”¹ã€‚"
            exit 0
          fi

          EXPECTED_CONTENT=$(printf '\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B')
          # è¯»å–å½“å‰å€¼
          CURRENT_CONTENT=$(dd if="$EEPROM_FILE" bs=1 skip=$((0x445)) count=20 2>/dev/null)
          
          if [ "$CURRENT_CONTENT" != "$EXPECTED_CONTENT" ]; then
            echo "âœ… æ­£åœ¨åº”ç”¨ 5G 25dB ä¿®æ”¹..."
            printf '\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B\x2B' | dd of="$EEPROM_FILE" bs=1 seek=$((0x445)) conv=notrunc
          else
            echo "â„¹ï¸ 5G 25dB å·²ç»ä¿®æ”¹è¿‡ï¼Œæ— éœ€é‡å¤æ“ä½œ"
          fi

      # ğŸ”¥ğŸ”¥ğŸ”¥ã€åˆ·æ–°ã€‘Cache Key æ›´æ–°ä¸º code-patch-v1 ğŸ”¥ğŸ”¥ğŸ”¥
      - name: ç¼“å­˜åŠ é€Ÿ (Cache)
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/.ccache
          key: ${{ runner.os }}-openwrt-${{ env.REPO_BRANCH }}-code-patch-v1-${{ hashFiles('openwrt/.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ env.REPO_BRANCH }}-code-patch-v1-

      - name: ä¸‹è½½è½¯ä»¶åŒ… (Download package)
        id: package
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶ (Compile the firmware)
        id: compile
        run: |
          cd openwrt
          
          echo "CONFIG_CCACHE=y" >> .config
          export CCACHE_DIR=$(pwd)/.ccache
          
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          
          # æå–ç‰ˆæœ¬å·
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "commit-$(git rev-parse --short HEAD)")
          echo "FIRMWARE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: ç”Ÿæˆ README è¯´æ˜
        run: |
          cat << EOF > README.md
          # OpenWrt RAX3000M å›ºä»¶
          
          - **ç‰ˆæœ¬**: ${{ env.FIRMWARE_VERSION }}
          - **è®¾å¤‡**: RAX3000M
          - **5G 25dB**: ${{ env.ENABLE_5G_25DB }}
          - **æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M %Z")
          - **é»˜è®¤åœ°å€**: 192.168.6.1 (å¯†ç ä¸ºç©º)
          
          ## å®‰è£…è¯´æ˜
          1. å¤‡ä»½é…ç½®
          2. é€šè¿‡ Web ç•Œé¢ä¸Šä¼ å›ºä»¶
          3. é‡å¯è®¾å¤‡
          
          ## æ³¨æ„
          ç¬¬ä¸‰æ–¹å›ºä»¶ï¼Œè‡ªè¡Œé£é™©ã€‚æ”¯æŒ: https://github.com/padavanonly/immortalwrt-mt798x-6.6
          EOF

      - name: ç”Ÿæˆå‘å¸ƒæè¿°
        run: |
          cat << EOF > release.txt
          # OpenWrt RAX3000M å›ºä»¶å‘å¸ƒ
          
          - **ç‰ˆæœ¬**: ${{ env.FIRMWARE_VERSION }}
          - **è®¾å¤‡**: RAX3000M
          - **5G 25dB**: ${{ env.ENABLE_5G_25DB }}
          - **æ—¶é—´**: $(date +"%Y-%m-%d %H:%M %Z")
          - **é»˜è®¤åœ°å€**: 192.168.6.1 (å¯†ç ä¸ºç©º)
          
          ## å®‰è£…
          1. å¤‡ä»½é…ç½®
          2. é€šè¿‡ Web ç•Œé¢ä¸Šä¼ å›ºä»¶
          3. é‡å¯è®¾å¤‡
          
          ## ç‰¹æ€§
          - âœ… ä¼˜åŒ–ç½‘ç»œæ€§èƒ½ï¼Œæ”¯æŒ USB å…±äº«ã€HNAT åŠ é€Ÿã€Ksmbd å…±äº«
          EOF
          
          if [ "${{ env.ENABLE_5G_25DB }}" == "true" ]; then
            echo "- âœ… 5G 25dB é«˜åŠŸç‡æ¨¡å¼" >> release.txt
          fi

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: OpenWrt_firmware_${{ env.FIRMWARE_VERSION }}_${{ env.DEVICE_NAME }}
          path: ${{ env.FIRMWARE }}

      - name: å‘å¸ƒå›ºä»¶åˆ° Release
        uses: softprops/action-gh-release@master
        if: steps.organize.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.FIRMWARE_VERSION }}-${{ github.sha }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: åˆ é™¤æ—§çš„ Release å‘å¸ƒ
        uses: dev-drprasad/delete-older-releases@master
        if: steps.organize.outputs.status == 'success'
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ é™¤æ—§çš„ Workflow è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep-minimum-runs: 2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
